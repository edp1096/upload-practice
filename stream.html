<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.17/dist/sweetalert2.all.min.js"></script>
</head>

<body>
    <div id="drop-zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
        <p>Drag one or more files to this Drop Zone</p>
    </div>
    <button onclick="completeUpload()">Complete upload</button>
    <pre id="msg"></pre>

</body>
<script>
    const formData = new FormData()
    const uploadTmpPath = "data_tmp"
    let orderCount = 0

    function deleteEntry(ord) {
        formData.delete("file" + ord)

        const cavity = document.getElementById("file-cavity" + ord)
        cavity.remove()
    }
    async function completeUpload() {
        var object = {};
        formData.forEach(function (value, key) {
            object[key] = value
        })
        var json = JSON.stringify(object)

        const response = await fetch("move.php", {
            method: "POST",
            headers: {},
            body: json
        })

        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const resultJSON = await response.json()
            console.log(resultJSON)
        } else {
            const resultTEXT = await response.text()
            console.log(resultTEXT)
        }
    }

    function showRemoteObject(obj, ord) {
        const cavity = document.getElementById("file-cavity" + ord)

        switch (obj.type) {
            case "image/jpeg":
            case "image/png":
                const img = document.createElement("img")
                img.setAttribute("id", "img" + ord)
                img.setAttribute("src", uploadTmpPath + "/" + obj.tmp_name)
                img.setAttribute("width", "100")
                cavity.appendChild(img)

                const iname = document.createElement("span")
                iname.setAttribute("id", "imgname" + ord)
                iname.innerText = obj.name
                cavity.appendChild(iname)

                const idel = document.createElement("button")
                idel.setAttribute("id", "del-img" + ord)
                idel.onclick = () => deleteEntry(ord)
                idel.innerText = "X"
                cavity.appendChild(idel)

                break
            default:
                const fname = document.createElement("span")
                fname.setAttribute("id", "filename" + ord)
                fname.innerText = obj.name
                cavity.appendChild(fname)

                const fdel = document.createElement("button")
                fdel.setAttribute("id", "del-file" + ord)
                fdel.onclick = () => deleteEntry(ord)
                fdel.innerText = "X"
                cavity.appendChild(fdel)

                break
        }

        return false
    }

    function futch(url, opts = {}, onProgress) {
        return new Promise((res, rej) => {
            var xhr = new XMLHttpRequest()
            xhr.open(opts.method || 'get', url)
            for (var k in opts.headers || {}) {
                xhr.setRequestHeader(k, opts.headers[k])
            }
            xhr.onload = e => res(e.target.responseText)
            xhr.onerror = rej
            if (xhr.upload && onProgress) {
                // event.loaded / event.total * 100 ; //event.lengthComputable
                xhr.upload.onprogress = onProgress
            }
            xhr.send(opts.body)
        })
    }


    async function dropHandler(ev) {
        // console.log('File(s) dropped')
        ev.preventDefault()

        const files = new Array()

        for (var i = 0; i < ev.dataTransfer.files.length; i++) {
            const cavity = document.createElement("div" + (orderCount + i))
            cavity.setAttribute("id", "file-cavity" + (orderCount + i))

            const progress = document.createElement("progress")
            progress.setAttribute("id", "progress-bar" + (orderCount + i))
            progress.setAttribute("value", "0")
            progress.setAttribute("max", "100")
            cavity.appendChild(progress)

            msg.appendChild(cavity)

            files.push(ev.dataTransfer.files[i])
        }
        readFormData(files)
    }

    function dragOverHandler(ev) {
        console.log('File(s) in drop zone')

        ev.preventDefault()
    }

    async function readFormData(files) {
        console.log("Begin Count: ", orderCount)

        let ord = 0

        // https://stackoverflow.com/questions/23223718/failed-to-execute-btoa-on-window-the-string-to-be-encoded-contains-characte
        for (let i = 0; i < files.length; i++) {
            const fcontent = btoa(await readFile(files[i]))
            const fname = files[i].name
            const ftype = files[i].type

            sendFile(fname, ftype, fcontent, (orderCount + i).toString())

            ord = orderCount + i
        }

        orderCount = ord + 1
    }

    // https://stackoverflow.com/questions/3582671/how-to-open-a-local-disk-file-with-javascript
    function readFile(file) {
        return new Promise((resolve, reject) => {
            let fr = new FileReader()
            fr.onload = x => resolve(fr.result)
            // fr.readAsText(file)
            fr.readAsBinaryString(file)
        })
    }

    async function sendFile(name, type, content, ord) {
        const uri = "upload-stream.php"
        // let uri = "http://localhost:10081/upload-stream/upload.php"
        const data = {
            name: name,
            type: type,
            content: content,
        }

        const response = await futch(uri, {
            method: "POST",
            body: JSON.stringify(data),
        }, (e) => {
            let pct = ((e.loaded / e.total) * 100).toFixed(2)

            console.log("file" + ord, pct)

            // document.getElementById("progress").innerHTML = pct + "%"
            document.getElementById("progress-bar" + ord).value = pct
        })

        const obj = JSON.parse(response)
        console.log(ord)
        formData.append("file" + ord, response)
        showRemoteObject(obj, ord)
    }

</script>
<style>
    #drop-zone {
        border: 5px solid blue;
        width: 200px;
        height: 100px;
    }
</style>

</html>